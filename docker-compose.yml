version: '3.8'

services:

  auth-api:
    build:
      context: ./auth-api
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-starlince}/auth-api:latest
    container_name: auth-api
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000

      DATABASE_URL: ${AUTH_DATABASE_URL:-postgresql://auth_user:auth_password@localhost:5432/auth_db?schema=public}
      JWT_SECRET: your-super-secret-jwt-key-here-change-in-production
      JWT_EXPIRES_IN: 1h
      JWT_ISSUER: auth-service
      JWT_AUDIENCE: api-services
    networks:
      - app-network
    restart: unless-stopped


  product-api:
    build:
      context: ./product-api
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-starlince}/product-api:latest
    container_name: product-api
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001


      DATABASE_URL: ${PRODUCT_DATABASE_URL:-postgresql://product_user:product_password@localhost:5433/product_db?schema=public}
      AUTH_SERVICE_URL: http://auth-api:3000
      JWT_ISSUER: auth-service
      JWT_AUDIENCE: api-services
    networks:
      - app-network
    restart: unless-stopped


  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-starlince}/gateway:latest
    container_name: gateway
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
      PORT: 4000
      AUTH_GRAPHQL_URL: http://auth-api:3000/api/graphql
      PRODUCT_GRAPHQL_URL: http://product-api:3001/api/graphql
      GRAPHQL_POLL_INTERVAL: "10000"
    networks:
      - app-network
    depends_on:
      - auth-api
      - product-api
    restart: unless-stopped


  ecommerce-app:
    build:
      context: ./ecommerce
      dockerfile: Dockerfile
    image: ${DOCKER_USERNAME:-starlince}/ecommerce:latest
    container_name: ecommerce-app
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      NEXT_PUBLIC_AUTH_API_URL: http://localhost:3000
      NEXT_PUBLIC_PRODUCT_API_URL: http://localhost:3001
    networks:
      - app-network
    depends_on:
      - auth-api
      - product-api
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
