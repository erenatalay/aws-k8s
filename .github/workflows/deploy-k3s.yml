name: Deploy to k3s

on:
  push:
    branches: [main, master]
    paths:
      - 'aws-k8s-helm/**'
      - 'auth-api/**'
      - 'product-api/**'
      - 'gateway/**'
      - 'ecommerce/**'
      - '.github/workflows/deploy-k3s.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - production

env:
  HELM_CHART_PATH: './aws-k8s-helm'

jobs:
  deploy:
    name: 'Deploy to k3s Cluster'
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'

      - name: Setup SSH and Kubeconfig
        run: |
          mkdir -p ~/.ssh ~/.kube
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # Get master IP from secrets or terraform
          MASTER_IP="${{ secrets.MASTER_IP }}"
          
          ssh-keyscan -H $MASTER_IP >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Download kubeconfig from master
          ssh -o StrictHostKeyChecking=no root@$MASTER_IP \
            "cat /etc/rancher/k3s/k3s.yaml" | \
            sed "s/127.0.0.1/$MASTER_IP/g" > ~/.kube/config
          
          chmod 600 ~/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespaces
        run: |
          kubectl create namespace ${{ github.event.inputs.environment || 'dev' }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Docker Registry Secret
        run: |
          kubectl create secret docker-registry regcred \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=${{ github.event.inputs.environment || 'dev' }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Application Secrets
        run: |
          kubectl create secret generic app-secrets \
            --from-literal=database-url="${{ secrets.DATABASE_URL }}" \
            --from-literal=jwt-secret="${{ secrets.JWT_SECRET }}" \
            --from-literal=redis-url="${{ secrets.REDIS_URL }}" \
            --namespace=${{ github.event.inputs.environment || 'dev' }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Helm Dependency Update
        run: |
          cd ${{ env.HELM_CHART_PATH }}
          helm dependency update

      - name: Helm Deploy
        run: |
          cd ${{ env.HELM_CHART_PATH }}
          helm upgrade --install aws-k8s-helm . \
            --namespace=${{ github.event.inputs.environment || 'dev' }} \
            --values=values.yaml \
            --values=values-local.yaml \
            --set global.environment=${{ github.event.inputs.environment || 'dev' }} \
            --set global.imageTag=${{ github.sha }} \
            --wait \
            --timeout=10m

      - name: Verify Deployment
        run: |
          kubectl get pods -n ${{ github.event.inputs.environment || 'dev' }}
          kubectl get svc -n ${{ github.event.inputs.environment || 'dev' }}

      - name: Get Service URLs
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Services:" >> $GITHUB_STEP_SUMMARY
          kubectl get svc -n ${{ github.event.inputs.environment || 'dev' }} -o wide >> $GITHUB_STEP_SUMMARY
