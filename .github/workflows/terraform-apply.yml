name: Terraform Apply

on:
  # Sadece manuel tetikleme - otomatik Ã§alÄ±ÅŸmaz
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - apply
          - destroy

env:
  TF_VERSION: '1.5.0'
  TF_WORKING_DIR: './terraform'

jobs:
  terraform-apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    environment: production
    
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: terraform init
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

      - name: Terraform Apply
        if: github.event.inputs.action != 'destroy'
        run: |
          terraform apply -auto-approve \
            -var="hcloud_token=${{ secrets.HCLOUD_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var-file="terraform-simple.tfvars"

      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        run: |
          terraform destroy -auto-approve \
            -var="hcloud_token=${{ secrets.HCLOUD_TOKEN }}" \
            -var="ssh_public_key=${{ secrets.SSH_PUBLIC_KEY }}" \
            -var-file="terraform-simple.tfvars"

      - name: Get Outputs
        if: github.event.inputs.action != 'destroy'
        id: outputs
        run: |
          echo "master_ip=$(terraform output -raw master_ip)" >> $GITHUB_OUTPUT

      - name: Setup SSH Key
        if: github.event.inputs.action != 'destroy'
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ steps.outputs.outputs.master_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Wait for k3s to be ready
        if: github.event.inputs.action != 'destroy'
        run: |
          echo "Waiting for k3s to initialize..."
          sleep 120
          
          for i in {1..30}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${{ steps.outputs.outputs.master_ip }} \
              "export KUBECONFIG=/etc/rancher/k3s/k3s.yaml && kubectl get nodes" 2>/dev/null; then
              echo "k3s is ready!"
              break
            fi
            echo "Waiting for k3s... attempt $i/30"
            sleep 10
          done

      - name: Download Kubeconfig
        if: github.event.inputs.action != 'destroy'
        run: |
          mkdir -p .kube
          ssh -o StrictHostKeyChecking=no root@${{ steps.outputs.outputs.master_ip }} \
            "cat /etc/rancher/k3s/k3s.yaml" | \
            sed "s/127.0.0.1/${{ steps.outputs.outputs.master_ip }}/g" > .kube/config

      - name: Upload Kubeconfig as Artifact
        if: github.event.inputs.action != 'destroy'
        uses: actions/upload-artifact@v4
        with:
          name: kubeconfig
          path: ${{ env.TF_WORKING_DIR }}/.kube/config
          retention-days: 1

      - name: Summary
        if: github.event.inputs.action != 'destroy'
        run: |
          echo "## ðŸš€ Cluster Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Master IP:** ${{ steps.outputs.outputs.master_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**SSH Access:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "ssh root@${{ steps.outputs.outputs.master_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
